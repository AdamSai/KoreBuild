use import="Json"
use import="Environment"

default NO_PARALLEL_TEST_PROJECTS='${E("NO_PARALLEL_TEST_PROJECTS")}'

@{/*

dnx-test
    Run unit tests in your project.

projectFile=''
    Required. Path to the test project.json to execute

framework=''
    Required. The TFM to run tests for

*/}

@{
    var projectFolder = Path.GetDirectoryName(projectFile);
    var projectName = Path.GetFileName(projectFolder);

    var noParallelTestProjects = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
    if (!string.IsNullOrEmpty(NO_PARALLEL_TEST_PROJECTS))
    {
        noParallelTestProjects.UnionWith(NO_PARALLEL_TEST_PROJECTS.Split((char)','));
    }

    var testArgs = noParallelTestProjects.Contains(projectName) || IsLinux ? " -parallel none" : "";

    if (framework.StartsWith("dnxcore", StringComparison.OrdinalIgnoreCase))
    {
        Dnx("test" + testArgs, projectFolder, "default -runtime coreclr");
    }
}
